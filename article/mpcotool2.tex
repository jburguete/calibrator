\documentclass[review,authoryear]{elsarticle}

\usepackage[utf8]{inputenc}
\usepackage{listings}
\usepackage{pstricks}
\usepackage{multido}
\usepackage{amsfonts}
\usepackage[hyphens]{url}
\expandafter\def\expandafter\UrlBreaks\expandafter{\UrlBreaks
  \do\a\do\b\do\c\do\d\do\e\do\f\do\g\do\h\do\i\do\j
  \do\k\do\l\do\m\do\n\do\o\do\p\do\q\do\r\do\s\do\t
  \do\u\do\v\do\w\do\x\do\y\do\z\do\A\do\B\do\C\do\D
  \do\E\do\F\do\G\do\H\do\I\do\J\do\K\do\L\do\M\do\N
  \do\O\do\P\do\Q\do\R\do\S\do\T\do\U\do\V\do\W\do\X
  \do\Y\do\Z}
\usepackage{multirow}
\usepackage{tabu}
\usepackage{lineno}
\linenumbers

\newcommand{\EQ}[2]
{\begin{equation}#1\label{#2}\end{equation}}

\newcommand{\PICTURE}[5]
{
	\begin{figure}[ht!]
		\centering
		\begin{picture}(#1,#2)
			#3
		\end{picture}
		\caption{#4.\label{#5}}
	\end{figure}
}

\newcommand{\PSPICTURE}[7]
{
	\begin{figure}[ht!]
		\centering
		\pspicture(#1,#2)(#3,#4)
			#5
		\endpspicture
		\caption{#6.\label{#7}}
	\end{figure}
}

\newcommand{\TABLE}[5]
{
	\begin{table}[ht!]
		\centering
		\caption{#4.\label{#5}}
		#1
		\tabulinesep=0.9mm
		\begin{tabu}{#2}
			#3
		\end{tabu}
	\end{table}
}

\newcommand{\FIG}[3]
{
	\begin{figure}[ht!]
		\centering
		\includegraphics[width=\textwidth]{#1}
		\caption{#2.\label{#3}}
	\end{figure}
}

\newcommand{\PLOT}[3]
{
	\begin{figure}[ht!]
		\centering
		\includegraphics{#1}
		\caption{#2.\label{#3}}
	\end{figure}
}

\newcommand{\FIGII}[4]
{
	\begin{figure}[ht!]
		\centering
		\begin{tabular}{c}
			\includegraphics{#1} \\ \includegraphics{#2}
		\end{tabular}
		\caption{#3.\label{#4}}
	\end{figure}
}

\newcommand{\PLOTII}[4]
{
	\begin{figure}[ht!]
		\centering
		\begin{tabular}{cc}
			\includegraphics{#1} & \includegraphics{#2}
		\end{tabular}
		\caption{#3.\label{#4}}
	\end{figure}
}

\newcommand{\FIGIII}[5]
{
	\begin{figure}[ht!]
		\centering
		\begin{tabular}{cc}
			\includegraphics{#1} & \includegraphics{#2} \\
			\multicolumn{2}{c}{\includegraphics{#3}}
		\end{tabular}
		\caption{#4.\label{#5}}
	\end{figure}
}

\newcommand{\FIGIV}[6]
{
	\begin{figure}[ht!]
		\centering
		\begin{tabular}{cc}
			\includegraphics{#1} & \includegraphics{#2} \\
			\includegraphics{#3} & \includegraphics{#4}
		\end{tabular}
		\caption{#5.\label{#6}}
	\end{figure}
}

\newcommand{\FIGVI}[8]
{
	\begin{figure}[ht!]
		\centering
		\begin{tabular}{cc}
			\includegraphics{#1} & \includegraphics{#2} \\
			\includegraphics{#3} & \includegraphics{#4} \\
			\includegraphics{#5} & \includegraphics{#6}
		\end{tabular}
		\caption{#7.\label{#8}}
	\end{figure}
}

\newcommand{\ABS}[1]{\left|#1\right|}
\newcommand{\C}[1]{\left[#1\right]}
\newcommand{\MATRIX}[2]{\PA{\begin{array}{#1}#2\end{array}}}
\newcommand{\PA}[1]{\left(#1\right)}
\newcommand{\LL}[1]{\left\{#1\right\}}

\bibliographystyle{elsarticle-harv}

\begin{document}

\title{MPCOTool: an open source software to supply empirical parameters
required in simulation models. II: practical applications}

\author[eead,bifi]{J. Burguete\corref{cor1}}
\ead{jburguete@eead.csic.es}

\author[kit]{S. Ambroj}
\ead{samuel.ambroj@kit.edu}

\author[eead]{B. Latorre}
\ead{borja.latorre@csic.es}

\author[unizar]{A. Lacasta}
\ead{alacasta@unizar.es}

\author[eead]{S. Ouazaa}
\ead{sofiane.ouazaa@eead.csic.es}

\author[eead]{N. Zapata}
\ead{v.zapata@csic.es}

\author[unizar]{P. García-Navarro}
\ead{pigar@unizar.es}

\cortext[cor1]{Corresponding author}

\address[eead]{Soil and Water, EEAD / CSIC.
P.O. Box 13034, 50080~Zaragoza, Spain.}
\address[bifi]{BIFI: Instituto de Biocomputación y Física de Sistemas Complejos,
Universidad de Zaragoza.
Mariano Esquillor, Edificio I+D, 50009~Zaragoza, Spain.}
\address[kit]{Steinbuch Centre for Computing (SCC),
Karlsruhe Institute of Technology (KIT).
KIT-Campus Nord, Hermann von Helmholtzplatz 1, 76344 Eggenstein - Leopoldshafen,
Germany.}
\address[unizar]{Fluid Mechanics, LIFTEC, CSIC-Universidad de Zaragoza.
María de Luna 3, 50018~Zaragoza, Spain.}

\begin{keyword}
optimization, calibration, simulation, model, software, irrigation, sprinkler,
furrow, canal
\end{keyword}

\begin{abstract}
In a previous companion paper MPCOTool, a new open source software to perform
optimization or calibration of empirical parameters required in the
formulation of numerical simulation models, is described.
The MPCOTool usage and possibilities are illustrated in this paper by showing
four practical
applications in agriculture: calibration of the empirical coefficients in a
surface irrigation model; calibration in a ballistic sprinkler irrigation model,
calibration in an irrigation engines movement model and optimization of a canal
management.
The ability of MPCOTool to achieve the maximum available computational efficiency by means of parallelization in a cluster is also shown.
\end{abstract}

\maketitle

\section{Introduction}

MPCOTool, the Multi-Purposes Calibration or Optimization Tool, a new open source
software to perform optimizations or calibrations of empirical parameters
required in the formulation of numerical simulation models is presented in a
previous companion paper.

In what follows, a few cases of practical application of MPCOTool in combination
with different simulation codes are presented. They deal with the optimization
or calibration of variables in models used for surface irrigation, sprinkler
irrigation, irrigation engines movement and open channel flow. All input data
files can be downloaded from the web page \citep{MPCOToolGit}.

Most of the cases have been run on the laptop computer described in the previous
section. Then, the computation has been performed in four parallelized tasks to
make the most of the processor's double nucleus with hyperthreading.
Only the optimization of the management of the Canal de Violada, much more computationally expensive, has been performed in the BIFI cluster Memento
(\url{http://bifi.es/es/infrastructures/scientific-equipment/memento-caesaraugusta}) using 64 threads.

\section{Practical applications}

\subsection{Calibration of empirical parameters on surface irrigation}

MPCOTool has also been used to find out the empirical parameters required by the friction and infiltration
models used in the open source software SURCOS \citep{Surcos,SurcosGit,JaviSurcos3} for the simulation of the four furrow fertigation experiments published in \citet{JaviSurcos2}. The furrows were $100$ m long and they were simulated using 100 computational cells per furrow. The furrows were close together, they had the same geometry and the experiments were almost simultaneous, hence the soil properties were assumed uniform. 
Fig.~\ref{FigSurcosSketch} displays the furrows geometry as well as the measurement points of the fertilizer 
concentration. 

\psset{xunit=15mm,yunit=15mm}
\PSPICTURE{-0.7}{-0.4}{6.5}{2.45}
{
	\scriptsize
	\psline(0,0.27)(0.2,0.27)(0.53,0)(0.67,0)
		(1,0.27)(1.2,0.27)(1.53,0)(1.67,0)
		(2,0.27)(2.2,0.27)(2.53,0)(2.67,0)
		(3,0.27)(3.2,0.27)(3.53,0)(3.67,0)(4,0.27)(4.2,0.27)
	\psline(0,0.27)(2,2.27)
	\psline(0.2,0.27)(2.2,2.27)
	\psline(0.53,0)(2.53,2)
	\psline(0.67,0)(2.67,2)
	\psline(1,0.27)(3,2.27)
	\psline(1.2,0.27)(3.2,2.27)
	\psline(1.53,0)(3.53,2)
	\psline(1.67,0)(3.67,2)
	\psline(2,0.27)(4,2.27)
	\psline(2.2,0.27)(4.2,2.27)
	\psline(2.53,0)(4.53,2)
	\psline(2.67,0)(4.67,2)
	\psline(3,0.27)(5,2.27)
	\psline(3.2,0.27)(5.2,2.27)
	\psline(3.53,0)(5.53,2)
	\psline(3.67,0)(5.67,2)
	\psline(4,0.27)(6,2.27)
	\psline(4.2,0.27)(6.2,2.27)
	\psline(2,2.27)(2.2,2.27)(2.53,2)(2.67,2)
		(3,2.27)(3.2,2.27)(3.53,2)(3.67,2)
		(4,2.27)(4.2,2.27)(4.53,2)(4.67,2)
		(5,2.27)(5.2,2.27)(5.53,2)(5.67,2)(6,2.27)(6.2,2.27)
	\psline[linestyle=dashed, dash=2pt 1pt](0,0.27)(-0.2,0.27)
	\psline[linestyle=dashed, dash=2pt 1pt](0.53,0)(-0.2,0)
	\psline{<->}(-0.1,0.27)(-0.1,0)
	\rput(-0.4,0.135){0.27m}
	\psline[linestyle=dashed, dash=2pt 1pt](2,2.27)(1.8,2.27)
	\psline{<->}(-0.1,0.27)(1.9,2.27)
	\rput(0.6,1.27){100m}
	\psline[linestyle=dashed, dash=2pt 1pt](0.53,0)(0.53,-0.2)
	\psline[linestyle=dashed, dash=2pt 1pt](0.67,0)(0.67,-0.2)
	\psline{->}(0.43,-0.1)(0.53,-0.1)
	\psline{->}(0.77,-0.1)(0.67,-0.1)
	\rput(0.6,-0.3){0.14m}
	\psline[linestyle=dashed, dash=2pt 1pt](1.2,0.27)(1.2,-0.2)
	\psline[linestyle=dashed, dash=2pt 1pt](2,0.27)(2,-0.2)
	\psline{<->}(1.2,-0.1)(2,-0.1)
	\rput(1.6,-0.3){0.80m}
	\psline[linestyle=dashed, dash=2pt 1pt](2.2,0.27)(2.2,-0.2)
	\psline{<->}(2,-0.1)(2.2,-0.1)
	\rput(2.1,-0.3){0.20m}
	\psline[linestyle=dashed, dash=2pt 1pt](4.2,0.27)(4.4,0.27)
	\psline[linestyle=dashed, dash=2pt 1pt](0.4,0.67)(4.8,0.67)
	\psline{<->}(4.3,0.27)(4.7,0.67)
	\rput(4.8,0.47){20m}
	\rput(5,0.67){S20}
	\psline[linestyle=dashed, dash=2pt 1pt](0.8,1.07)(5.2,1.07)
	\psline{<->}(4.7,0.67)(5.1,1.07)
	\rput(5.2,0.87){20m}
	\rput(5.4,1.07){S40}
	\psline[linestyle=dashed, dash=2pt 1pt](1.2,1.47)(5.6,1.47)
	\psline{<->}(5.1,1.07)(5.5,1.47)
	\rput(5.6,1.27){20m}
	\rput(5.8,1.47){S60}
	\psline[linestyle=dashed, dash=2pt 1pt](1.6,1.87)(6,1.87)
	\psline{<->}(5.5,1.47)(5.9,1.87)
	\rput(6,1.67){20m}
	\rput(6.2,1.87){S80}
	\rput(2.6,2.3){Q1}
	\rput(3.6,2.3){Q2}
	\rput(4.6,2.3){Q3}
	\rput(5.6,2.3){Q4}
	\rput(4.5,0){INLET}
}{Illustrative diagram of the dimensions of the experiments at four isolated
furrows as described in \citet{JaviSurcos2}. Q1, Q2, Q3 and Q4 are the 
respective discharges of 1, 2, 3 and 4 l/s. S20, S40, S60 and S80
are the locations where the fertilizer concentration was measured}
{FigSurcosSketch}

The friction model used in SURCOS is the Gauckler-Manning model. The infiltration model is the Kostiakov model. They require calibration of three coefficients: the Gauckler-Manning number $n$ (s$\cdot$m$^{-1/3}$) and the Kostiakov infiltration parameters $K$ (m$\cdot$s$^{-a}$) and $a$ (dimensionless). In the original paper, a brute force method using 3000 simulations was applied, each of them including the four experiments.

Defining $N_a$ the number of gauging stations for time of advance, calling
$t_j$ the measured times at every $j$-th gauging station and $T_j$ those
obtained from the simulation, the error in advance is defined as:
\EQ{E_a=\frac{1}{N_a\,\PA{t_{N_a}}^2}\,\sum_{j=1}^{N_a}\PA{t_j-T_j}^2.}
{EqSurcosErrorAdvance}
On the other hand, having $N_c$ fertilizer concentration gauging stations and
assuming that at every $k$-th gauging station $N_k$ concentration measurements
$s_k^j$ have been obtained and there are $S_k^j$ numerical concentration values
from the model, the error in concentration is defined as:
\EQ
{
	E_c=\frac{1}{N_c\,(10.6)^2}\,\sum_{k=1}^{N_c}\frac{1}{N_k}\,
	\sum_{j=1}^{N_k}\PA{s_k^j-S_k^j}^2,
}{EqSurcosErrorConcentration}
where $10.6$ kg/m$^3$ is the maximum experimental fertilizer concentration. If
there are $N_h$ upstream water depth measurements denoted $h_i$ and $H_i$ water
depth simulated values are available, the error in water depth is defined as:
\EQ{E_h=\frac{1}{N_h\,\PA{h_{N_h}}^2}\,\sum_{j=1}^{N_h}\PA{h_j-H_j}^2.}
{EqErrorDepth}
The objective function for each furrow experiment has been defined as:
\EQ{o=E_a+0.5\,\PA{E_c+E_h}.}{EqSurcosObjective}
$L_2$ norm with weights $w_i=1$ has been use to compose the final objective function from the four experiments. In the present work, the same number of simulations has been used with the calibration methods implemented in MPCOTool. The execution of 3000 simulations in the laptop computer took about 1h30m.

Table~\ref{TabSurcos} displays the results obtained for the optimal coefficient values and the corresponding
value of the evaluation function, where the error norm is the same as in \citet{JaviSurcos2}. The results are similar among the different methods and also similar to those in the original paper. This is due to the existence of a relatively large region of combinations of the empirical parameters producing similar values in the evaluation function, thus preventing from an accurate convergence to the optimum set. However, it can be noticed that MC+IT obtains the best results and MC-RA and GE produce better results than MC with the same total number of simulations.

\TABLE{\footnotesize}{cccc}
{
	Optimization & Optimization & Optimal empirical & Objective
	\\ algorithm & parameters & parameters & function value
	\\ \hline
	MC & $N_s=3000$ & $n=0.0444$ s$\cdot$m$^{-1/3}$ & 0.6971
	\\ & & $K=9.690\cdot 10^{-4}$ m$\cdot$s$^{-a}$
	\\ & & $a=0.503$
	\\ \hline
	MC+IT & $N_s=500$, $N_i=6$ & $n=0.0420$ s$\cdot$m$^{-1/3}$ & 0.6903
	\\ & $N_b=10$ & $K=10.147\cdot 10^{-4}$ m$\cdot$s$^{-a}$
	\\ & $tol=0.2$ & $a=0.504$
	\\ \hline
	MC+DS+RA & $N_s=2200$, $N_i=1$ & $n=0.0421$ s$\cdot$m$^{-1/3}$ & 0.6928
	\\ & $N_{st}=200$, $N_e=4$ & $K=9.712\cdot 10^{-4}$ m$\cdot$s$^{-a}$
	\\ & $rel=1$ & $a=0.512$
	\\ & $st_n=0.0010$ s$\cdot$m$^{-1/3}$
	\\ & $st_K=10^{-6}$ m$\cdot$s$^{-a}$
	\\ & $st_a=0.010$
	\\ \hline
	GE & $N_p=750$ & $n=0.0413$ s$\cdot$m$^{-1/3}$  & 0.6930
	\\ & $N_g=6$ & $K=9.823\cdot 10^{-4}$ m$\cdot$s$^{-a}$
	\\ & $R_m=R_r=R_a=0.2$ & $a=0.508$
	\\ \hline
	GE & $N_p=300$ & $n=0.0420$ s$\cdot$m$^{-1/3}$  & 0.6918
	\\ & $N_g=31$ & $K=9.903\cdot 10^{-4}$ m$\cdot$s$^{-a}$
	\\ & $R_m=R_r=R_a=0.1$ & $a=0.508$
	\\ \hline
}{Optimal empirical parameters and value of the evaluation function in the simulation of the furrow irrigation cases in \citet{JaviSurcos2} using program SURCOS and several optimization algorithms in MPCOTool with the same total number of simulations ($N_{total}=3000$)}{TabSurcos}

Fig.~\ref{FigSurcos} shows the results of the water depths and solute concentration from the simulation, using the coefficients obtained by the MC+IT method, compared with the experimental values.

\FIGVI{surcos-advance.eps}{surcos-depth.eps}{surcos-solute-q1.eps}
{surcos-solute-q2.eps}{surcos-solute-q3.eps}{surcos-solute-q4.eps}
{(top left) Advance time profile, (top right) inlet depth evolution and
(middle-bottom) solute concentration evolution at probes for the experiments
Q1-Q4 described in \citet{JaviSurcos2} simulated with the optimal calibrated
parameters obtained for the MC+IT method (see table~\ref{TabSurcos})}{FigSurcos}

\subsection{Calibration of empirical parameters of the ballistic model on
sprinkler irrigation}

The ballistic model \citep{Fukui80,Playan06} is the most widespread to characterize the behaviour and performance of sprinklers in sprinkler irrigation management. The model assumes that the travelling drops are approximately spherical and subject to the resulting effect of gravity and drag forces. The ejecting drop velocity is required by the model, and it is frequent to assume that the jet is compact enough to consider that all the drops carry the same velocity when leaving the sprinkler. This velocity can be estimated either by measuring the pressure and using Bernoulli's equation or, alternatively, by measuring the discharge and dividing by the outlet cross section. Other data required to characterize the water spread are related to the drop size distribution. The model used in the present work, described in \cite{Ouazaa14}, is based on three parameters $D_{50}$ (mm), $n$ (dimensionless) and $P$ (dimensionless) to define the probability density of drop sizes ($p$):
\[
	f(D)=0.693\,n\,\PA{\frac{D}{D_{50}}}^{n-1}
	\,\exp\C{-0.693\,\PA{\frac{D}{D_{50}}}^n},
\]
\EQ
{
	g(D)=\left\{\begin{array}{lc}0,&D\leq D_{min};\\
	\max[P,\;f(D)],&D_{min}<D<D_{50};\\f(D),&D_{50}\leq D\leq D_{max};\\
	0,&D>D_{max};\end{array}\right.\quad
	p(D)=\frac{g(D)}{\int_0^\infty g(D)\,dD}.
}{EqSprinklerDropSizes}
with $D$ the drop diameter, and $D_{min}$ and $D_{max}$ the minimum and maximum
allowed drop diameters respectively.

Furthermore, to include the influence of the wind, the model involves two more dimensionless aerodynamic resistance coefficients ($k_1$ and $k_2$) modifying the drag resistance coefficient $c_d$ as:
\EQ{c_d=c_s\,\PA{1+k_1\,\sin\beta-k_2\,\cos\alpha}}{EqSprinklerDrag}
with $c_s$ the drag resistance coefficient of a solid sphere, $\beta$ the angle
between the drop velocity relative to the wind and the wind velocity, and
$\alpha$ the angle between the drop velocity relative to the wind and the drop
absolute velocity.

The model is calibrated in two steps. First, the coefficients $D_{50}$, $n$ and $P$ are fitted to adjust the water distribution in windless conditions and are considered representative of the sprinkler model at a given pressure. In a second step, the coefficients $k_1$ and $k_2$ fitting better the water distribution in windy conditions are found.

In the present example, a spray sprinkler Senninger N44 at a working pressure of 138 kPa will be calibrated. In this sprinkler model, the water jet impacts against a fixed plate. In order to estimate the water velocity after the impact, an image technique as described in \citet{Salvador09} was applied. According to this measurements, the head loss due to the impact against the plate was found to be of 50\%. Extremal drop diameters have been fixed to $D_{min}=0.5$~mm and
$D_{max}=7.0$~mm. A set of 360000 drop trajectories has been numerically calculated to simulate the sprinkler pluviometry. The objective function has been defined as:
\EQ{o=\frac{RMSE}{1+R},}{EqSprinklerObjective}
with $RMSE$ the root mean square error and $R$ the statistical coefficient obtained by the
measured and simulated pluviometries. The pluviometers were placed every 0.5~m along two axes
oriented East-West (E-W) and North-South (N-S) approximately.

Table~\ref{TabSprinklerI} shows the results from the calibration of parameters $D_{50}$, $n$ and $P$ in windless conditions using a total number of 1000 simulations with different optimization algorithms. The computation time was around 8 minutes in the laptop computer for each calibration. The results show that the best results are supplied by MC+IT followed by GE. In this case,
MC+DS+RA barely improves the results obtained by MC 
and SW leads to worse results, mainly when supplied with IT. 

\TABLE{\footnotesize}{cccc}
{
	Optimization & Optimization & Optimal empirical & Objective
	\\ algorithm & parameters & parameters & function value
	\\ \hline
	SW & $N_{D_{50}}=N_n=N_P=10$ & $D_{50}=3.78$ mm & 2.65 mm
	\\ & & $n=17.778$
	\\ & & $P=0.556$
	\\ \hline
	SW+IT & $N_{D_{50}}=N_n=N_P=5$ & $D_{50}=3.50$ mm & 3.32 mm
	\\ & $N_i=N_b=8$ & $n=10.130$
	\\ & $tol=0.4$ & $P=0.400$
	\\ \hline
	MC & $N_s=1000$ & $D_{50}=3.07$ mm & 2.18 mm
	\\ & & $n=21.513$
	\\ & & $P=0.770$
	\\ \hline
	MC+IT & $N_s=125$ & $D_{50}=3.05$ mm & 1.83 mm
	\\ & $N_i=N_b=8$ & $n=18.267$
	\\ & $tol=0.4$ & $P=0.389$
	\\ \hline
	MC+DS+RA & $N_s=500$ & $D_{50}=3.07$ mm & 2.17 mm
	\\ & $N_{st}=125$, $N_e$=4 & $n=21.515$
	\\ & $rel=1$ & $P=0.759$
	\\ & $st_{D_{50}}=0.10$ mm
	\\ & $st_N=0.010$
	\\ & $st_P=0.010$
	\\ \hline
	GE & $N_p=250$ & $D_{50}=3.02$ mm & 1.94 mm
	\\ & $N_g=6$ & $n=16.204$
	\\ & $R_m=R_r=R_a=0.2$ & $P=0.386$
	\\ \hline
	GE & $N_p=100$ & $D_{50}=3.06$ mm & 1.91 mm
	\\ & $N_g=31$ & $n=20.170$
	\\ & $R_m=R_r=R_a=0.1$ & $P=0.506$
	\\ \hline
}{Optimal empirical parameters and value of the evaluation function in the case of the sprinkler irrigation
using different optimization algorithms in MPCOTool with the same number of total simulations ($N_{total}=1000$)}{TabSprinklerI}

Next, using the optimal $D_{50}=3.05$ mm, $n=18.267$ and $P=0.389$ obtained by MC+IT the values of $k_1$ and $k_2$ were calibrated in an experiment with medium wind velocity of 2.84 m/s. The different algorithms in MPCOTool were used with a total number of 400 simulations in all cases. Their computational time was around 4 minutes in the laptop computer for each calibration. In this case, SW+IT provided the best results, although the rest of the methods reached similar values.

\TABLE{\footnotesize}{cccc}
{
	Optimization & Optimization & Optimal empirical & Objective
	\\ algorithm & parameters & parameters & function value
	\\ \hline
	SW & $N_{k_1}=N_{k_2}=20$ & $k_1=0.316$ & 11.402 mm
	\\ & & $k_2=0.053$
	\\ \hline
	SW+IT & $N_{k_1}=N_{k_2}=10$, $N_i=4$ & $k_1=0.344$ & 11.266 mm
	\\ & $N_b=11$, $tol=0.2$ & $k_2=0.068$
	\\ \hline
	MC & $N_s=400$ & $k_1=0.203$ & 11.475 mm
	\\ & & $k_2=0.106$
	\\ \hline
	MC+IT & $N_s=100$, $N_i=N_b=4$ & $k_1=0.300$ & 11.270 mm
	\\ & $tol=0.2$ & $k_2=0.084$
	\\ \hline
	MC+DS+RA & $N_s=300$, $N_{st}=25$ & $k_1=0.176$ & 11.337 mm
	\\ & $N_e=4$, $rel=1$& $k_2=0.106$
	\\ & $st_{k_1}=st_{k_2}=0.010$
	\\ \hline
	GE & $N_p=100$, $N_g=6$ & $k_1=0.099$ & 11.499 mm
	\\ & $R_m=R_r=R_a=0.2$ & $k_2=0.128$
	\\ \hline
	GE & $N_p=100$, $N_g=11$ & $k_1=0.322$ & 11.315 mm
	\\ & $R_m=R_r=R_a=0.1$ & $k_2=0.060$
	\\ \hline
}{Optimal parameters and values of the evaluations function in the experiment of the sprinkler irrigation under windy conditions of 2.84 m/s using different optimization algorithms implemented in MPCOTool with the same total number of simulations ($N_{total}=400$)}{TabSprinklerII}

Finally, figure~\ref{FigSprinkler} shows the measured (in pluviometers) and simulated water distribution using the optimal parameters obtained by SW+IT in windless and windy conditions of average velocity 2.84 m/s.

\FIGII{sprinkler-0.eps}{sprinkler-2,84.eps}
{(top) Radial pluviometry for non-windy conditions and (bottom) pluviometry at
the two pluviometers axes with wind average velocity 2.84 m/s}{FigSprinkler}

\subsection{Calibration of empirical parameters of the movement of a
sprinkler center-pivot}

The movement of a center-pivot tower follows a chaotic pattern depending on the movement of the exterior tower, the tower start and stop angles and the start and stop velocities. In \citet{Ouazaa15} a model was proposed to simulate the tower movements and several controlled experiments  were carried out to measure them in a real field center-pivot. The exterior tower controls the movement, with a sequence of working periods that depend on the cycle period and the working percentage, both adjustable to reach a desired irrigation service. The rest of the towers move according to a complex pattern (see figure~\ref{FigPivotDiagram}). 

\psset{unit=1mm}
\PSPICTURE{-10}{-6}{93}{20}
{
	\rput(25,17){$\alpha_i<\alpha_{start}\;\Rightarrow\;T_i$ start}
	\rput(65,17){$\alpha_i>\alpha_{stop}\;\Rightarrow\;T_i$ stop}
	\psarc{->}(0,0){93}{0}{7}
	\psline(0,0)(20,0)(40,1)(60,2.5)(90,5.5)
	\pscircle*(20,0){0.5}
	\pscircle*(40,1){0.5}
	\pscircle*(60,2.5){0.5}
	\pscircle*(80,4.5){0.5}
	\pscircle*(0,0){1.0}
	\rput(0,-3){Centre}
	\rput(20,-3){$T_1$}
	\rput(40,-2){$T_2$}
	\rput(60,-0.5){$T_3$}
	\rput(80,1.5){$T_4$}
	\psarc(20,0){3}{2.86}{180}
	\psarc(40,1){3}{4.29}{177.14}
	\psarc(60,2.5){3}{5.71}{175.71}
	\rput(20,6){$\alpha_1$}
	\rput(40,7){$\alpha_2$}
	\rput(60,8.5){$\alpha_3$}
}{Example of movement of a centre-pivot irrigation engine with
four towers}{FigPivotDiagram}

The model includes four empirical parameters to calibrate: the average angles of start $\overline{\alpha_{start}}$ and stop $\overline{\alpha_{stop}}$, the uncertainty in these angles $\delta$ and the start and stop times $\tau$. In every tower cycle, the start and stop angles are obtained as:
\EQ
{
	\alpha_{start}=\overline{\alpha_{start}}+(r-0.5)\,\delta,\quad
	\alpha_{stop}=\overline{\alpha_{stop}}+(r-0.5)\,\delta,
}{EqPivotStartStop}
with $r$ a random number defined with sinusoidal probability, to favor central
angles, in the range $r\in[0,1)$. The same time $\tau$ is considered for start
and stop, and the velocity increases or decreases linearly (see
Fig.~\ref{FigPivotVelocity}).

\psset{unit=1mm}
\PSPICTURE{-16}{-6}{75}{39}
{
	\footnotesize
	\psline{->}(0,0)(0,30)
	\psline{->}(0,0)(70,0)
	\rput(0,36){Tower}
	\rput(0,32){linear velocity}
	\rput(70,-3){Time}
	\psline(0,0)(10,0)(15,20)(25,20)(30,0)(45,0)(50,20)(60,20)(65,0)
	\rput(-8,22){Maximum}
	\rput(-8,18){velocity}
	\psline[linestyle=dotted](0,20)(15,20)
	\psline{<->}(10,23)(15,23)
	\rput(12.5,26){$\tau$}
	\psline{<->}(10,29)(30,29)
	\rput(20,35){Start}
	\rput(20,32){time}
	\psline{<->}(25,23)(30,23)
	\rput(27.5,26){$\tau$}
	\psline{<->}(30,23)(45,23)
	\rput(37.5,29){Stop}
	\rput(37.5,26){time}
}{Linear velocity of a centre-pivot tower on starts and stops}{FigPivotVelocity}

The movement of a real pivot with four towers separated 50.11 m is next simulated and calibrated. The maximum linear velocity of each tower were measured to be: $v_1=0.02738$ m/s, $v_2=0.02824$ m/s, $v_3=0.03008$ m/s and $v_4=0.03779$ m/s.
The exterior tower is considerably faster as it carries less weight and produces less friction.
The start and stop times of each tower were measured in four experiments of 24 hours with the pivot working in cycles of 71 s at 100\%, 50\%, 40\% and 25\%.

The run and stop time intervals were grouped every 10 minutes in histograms for each tower and the evaluation function was defined as:
\EQ
{
	o=\sqrt{\frac{1}{N_{towers}}\,\sum_{i=1}^{N_{towers}}
	\sum_{j=1}^{N_{intervals}}\PA{n_r-N_r}_{i,j}^2+\PA{n_s-N_s}_{i,j}^2}
}{EqPivotObjective}
with $N_{towers}=4$ the number of towers, $N_{intervals}$ the number of
histograms time intervals, $\PA{n_r}_{i,j}$ and $\PA{N_r}_{i,j}$ the measured
and the simulated number of runs respectively for the $i$-th tower and the
$j$-th time interval, and $\PA{n_s}_{i,j}$ and $\PA{N_s}_{i,j}$ the measured
and the simulated number of stops respectively for the $i$-th tower and the
$j$-th time interval. $L_2$ norm with $w_i=1$ has been used to compose the
objective function with the four experiments.

Table~\ref{TabPivot} shows some of the results obtained in a total of 10000 simulations for each of the four experiments, taking around 50 minutes each in the same laptop computer used before. The best results where obtained with SW+IT.
Pure brute force algorithms obtain the worst results.

\TABLE{\footnotesize}{cccc}
{
	Optimization & Optimization & Optimal empirical & Objective
	\\ algorithm & parameters & parameters & function value
	\\ \hline
	SW & $N_x=10$ & $\overline{\alpha_{start}}=179.956^\circ$
	& 63.03
	\\ & & $\overline{\alpha_{stop}}=180.367^\circ$
	\\ & & $\delta=0.133^\circ$
	\\ & & $\tau=1.73$ s
	\\ \hline
	SW+IT & $N_x=5$ & $\overline{\alpha_{start}}=180.448^\circ$
	& 44.30
	\\ & $N_i=16$ & $\overline{\alpha_{stop}}=180.848^\circ$
	\\ & $N_b=10$ & $\delta=0.098^\circ$
	\\ & $tol=0.5$ & $\tau=2.24$ s
	\\ \hline
	MC & $N_s=10000$
	& $\overline{\alpha_{start}}=179.739^\circ$ & 61.49
	\\ & $N_i=1$ & $\overline{\alpha_{stop}}=180.139^\circ$
	\\ & & $\delta=0.120^\circ$
	\\ & & $\tau=2.35$ s
	\\ \hline
	MC+IT & $N_s=625$
	& $\overline{\alpha_{start}}=179.760^\circ$ & 49.14
	\\ & $N_i=16$ & $\overline{\alpha_{stop}}=180.159^\circ$
	\\ & $N_b=10$ & $\delta=0.101^\circ$
	\\ & $tol=0.1$ & $\tau=2.29$ s
	\\ \hline
	MC+DS+CD & $N_s=9000$, $N_{st}=125$
	& $\overline{\alpha_{start}}=179.743^\circ$ & 54.42
	\\ & $rel=1$ & $\overline{\alpha_{stop}}=180.138^\circ$
	\\ & $st_{\overline{\alpha_{start}}}=0.4$ & $\delta=0.120^\circ$
	\\ & $st_{\overline{\alpha_{stop}}}=0.3$ & $\tau=2.36$ s
	\\ & $st_\delta=0.004$
	\\ & $st_\tau=0.05$
	\\ \hline
	GE & $N_p=1000$ & $\overline{\alpha_{start}}=179.967^\circ$
	& 49.41
	\\ & $N_g=16$ & $\overline{\alpha_{stop}}=180.367^\circ$
	\\ & $R_m=R_r=R_a=0.2$ & $\delta=0.101^\circ$
	\\ & & $\tau=2.22$ s
	\\ \hline
	GE & $N_p=400$ & $\overline{\alpha_{start}}=179.933^\circ$
	& 48.08
	\\ & $N_g=81$ & $\overline{\alpha_{stop}}=180.327^\circ$
	\\ & $R_m=R_r=R_a=0.1$ & $\delta=0.112^\circ$
	\\ & & $\tau=2.60$s
	\\ \hline
}{Optimal parameters and values of the evaluation function in the four towers pivot case in \citet{Ouazaa15} using different optimization algorithms implemented in MPCOTool with the same number of total simulations ($N_{total}=10000$). $N_x$ is the sweeps number for every variable in SW}{TabPivot}

In figures \ref{FigPivot100} to \ref{FigPivot25} the histograms of the number
of measured and simulated starts and stops are represented for the different
machine workings.
Note that the figures are not represented with uniform scales to better
visualization of the differences among measured and simulated results.
The agreement between measured and simulated data when using the parameters calibrated with the optimal genetic algorithm must be considered reasonable taking into account the chaotic character of the movement.
However, coupling a sprinkler irrigation model, it could be concluded that losses in water distribution uniformity associated to the tower movement variability can be considered negligible \citep{Ouazaa15}.

\FIGIV{pivot-measured-starts-100.eps}{pivot-measured-stops-100.eps}
{pivot-simulated-starts-100.eps}{pivot-simulated-stops-100.eps}
{Histogram of the number of (top left) measured starts, (top right) measured stops, (bottom left)
simulated starts and (bottom right) simulated stops for the pivot towers working at 100\%
velocity}{FigPivot100}

\FIGIV{pivot-measured-starts-50.eps}{pivot-measured-stops-50.eps}
{pivot-simulated-starts-50.eps}{pivot-simulated-stops-50.eps}
{Histogram of the number of (top left) measured starts, (top right) measured stops, (bottom left)
simulated starts and (bottom right) simulated stops for the pivot towers working at 50\%
velocity}{FigPivot50}

\FIGIV{pivot-measured-starts-40.eps}{pivot-measured-stops-40.eps}
{pivot-simulated-starts-40.eps}{pivot-simulated-stops-40.eps}
{Histogram of the number of (top left) measured starts, (top right) measured stops, (bottom left)
simulated starts and (bottom right) simulated stops for the pivot towers working at 40\%
velocity}{FigPivot40}

\FIGIV{pivot-measured-starts-25.eps}{pivot-measured-stops-25.eps}
{pivot-simulated-starts-25.eps}{pivot-simulated-stops-25.eps}
{Histogram of the number of (top left) measured starts, (top right) measured stops, (bottom left)
simulated starts and (bottom right)simulated stops for the pivot towers working at 25\% velocity}{FigPivot25}

To illustrate the chaotic movement of inner towers, in
Fig.~\ref{FigPivotV} the towers velocity is presented at an interval of
central working time.
\PLOT{pivot-velocity.eps}
{Towers velocity in an interval of 10 minutes after 10 hours of operation for
the pivot working at 25\% velocity}{FigPivotV}

\subsection{Optimization of a canal management}

A real irrigation canal has been analyzed in order to find out the optimal
values of two variables of interest which take into account the daily gate
opening modification time. The area of study is located in the North-east of
Spain, in the province of Huesca. It consists of the first 13657 meters of the
Canal de Violada. The studied stretch was designed for a maximum discharge of
6~m$^3$/s. This stretch delivers water to three irrigation communities:
Almudévar, Gurrea and El Temple. In figure~\ref{FigViolada} a diagram with the
gates and spillways locations is shown.
\psset{xunit=9mm,yunit=6mm}
\PSPICTURE{-1}{-2}{11.4}{2}
{
	\scriptsize
	\rput(-0.5,0){Inlet}
	\rput(10.7,0){Outlet}
	\psline(0,0)(10,0)
	\psline{->}(7.5,0)(7.5,-1)
	\rput(7.5,-1.4){Spillway}
	\psline{->}(10,0)(10,-1)
	\rput(10,-1.4){Spillway}
	\psline{->}(3,0)(3,1)
	\rput(3,1.4){Almudévar}
	\psline{->}(8.5,0)(7.5,1)
	\rput(7.5,1.4){Gurrea}
	\psline{->}(9,0)(10,1)
	\rput(10,1.4){El Temple}
	\psline{<->}(0,-0.3)(3,-0.3)
	\rput(1.5,-0.7){5007 m}
	\psline{<->}(3,-0.3)(7.5,-0.3)
	\rput(5.25,-0.7){8346 m}
	\psline{<->}(7.5,-0.3)(8.5,-0.3)
	\rput(8,-0.7){270 m}
	\psline{<->}(8.5,-0.3)(9,-0.3)
	\rput(8.75,-0.7){7 m}
	\psline{<->}(9,-0.3)(10,-0.3)
	\rput(9.5,-0.7){27 m}
}{Sketch showing the position of the two spillways and the three gates on the
Canal de Violada. The dimensions are not on scale for a better visualization}
{FigViolada}

Two cross sections can be distinguished in the channel, the longer 13353 meters initial reach
and the last 304 meters. Both share the same bottom slope, $S_0$ = 0.00059 but
they differ in the cross section dimensions, as shown in
Fig.~\ref{FigCrossSections}, and in the value of the Gauckler-Manning
roughness coefficient (0.014 and 0.02~s~m$^{-1/3}$ for the first
and the final reaches respectively). The values correspond to polished and
coarse concrete \citep{Chow59}.
\psset{xunit=9mm,yunit=9mm}
\PSPICTURE{0}{-0.6}{12.7}{2.450}
{
	\psline(0,2.050)(0.615,0)(3.259,0)(3.874,2.050)
	\psline{<->}(0.615,-0.2)(3.259,-0.2)
	\rput(1.937,-0.4){2.644 m}
	\psline{<->}(0,2.250)(3.874,2.250)
	\rput(1.937,2.450){3.874 m}
	\psline{<->}(4.074,0)(4.074,2.050)
	\rput(4.774,1.025){2.050 m}
	\psline(5.5,1.8)(5.5,1.5)(7,0)(9.5,0)(11,1.5)(11,1.8)
	\psline{<->}(5.5,2)(11,2)
	\rput(8.25,2.2){5.500 m}
	\psline{<->}(7,-0.2)(9.5,-0.2)
	\rput(8.25,-0.4){2.500 m}
	\psline{<->}(11.2,0)(11.2,1.5)
	\rput(11.9,0.75){1.500 m}
	\psline{<->}(11.2,1.5)(11.2,1.8)
	\rput(11.95,1.65){0.300 m}
}{Channel cross sections for the first stretch of 13353 m (left) and the last part of 304 m (right)}{FigCrossSections}

The required discharge at every gate for a modernization scenario to sprinkler irrigation was obtained after an elaborate 
field analysis. Taking into account the crop distribution, soil water retention properties, the electricity cost depending on the hour of the day and the design of a 
reservoir in the area, seven different scenarios were obtained as a function of the historical irrigation requirements for 
the same period using real data \citep{Zapata09}. A 14 days period was selected from
one of these scenarios in order to optimize the channel management.

Two key optimization variables have been studied: $\Delta t_A$ and
$\Delta t_{GT}$. Where $\Delta t_A$ takes into account the delay between the
modification time of the inlet discharge and the modification time in the
Almudévar gate and $\Delta t_{GT}$ takes into account the delay between the
inlet and Gurrea and El Temple gates modification. Before the development of
this  study, the channel guards responsible for its management carried out the
gates opening using fixed values $\Delta t_A=$1h and $\Delta t_{GT}=$3h30m.
It is important to stress that Gurrea and El Temple gates are only separated by
a few meters and are located very close to the outlet gate.

The initial conditions for the canal were a steady state with a discharge of
2~m$^3$/s. The objective of this work was to provide
the required daily discharge to the three important irrigation gates as well as
to keep a constant discharge of 2 m$^3$/s at the outlet gate.
Then, the objective function has been defined as:
\EQ
{
	o=\frac{1}{N_{gates}\,N_{steps}}\,\sum_{i=1}^{N_{gates}}
	\sum_{j=1}^{N_{steps}}\ABS{Q_{g,i,j}-Q_{s,i,j}}^2
}{EqSwigsObjective}
with $N_{gates}=4$ the number of points of demand, $N_{steps}$ the number of 
time steps and $Q_{d,i,j}$ and $Q_{s,i,j}$ the demanded and simulated discharges
respectively at the $i$-th point of demand in the $j$-th time step. 

SWIGS open source software \citep{Swigs} has been used to simulate the channel
flow. Each optimization executed a total number of 1024 simulations and took 
approximately between 14 and 19 hours using 64 cores in the Memento cluster.

Table~\ref{TabSwigs} displays the results obtained for the optimal coefficient
values and the corresponding value of the evaluation function, where the error
norm is defined as the root mean square error between demanded discharges and
supplied discharges multiplied by a factor of 10 in cases of channel overflow.
The results are similar when comparing the different optimization methods.
MC+DS+RA achieves the best result. With the channel guards management pattern
this error norm is much higher, due not only to a greater error in the desired
outlet discharge but also to a slight overflow in one of the spillways of the
canal.

\TABLE{\footnotesize}{cccc}
{
	Optimization & Optimization & Optimal empirical & Objective
	\\ algorithm & parameters & parameters & function value
	\\ \hline
	\multicolumn{2}{c}{Manual management} & $\Delta t_A=3600$ s
	& 1.049056 m$^6$/s$^2$
	\\ & & $\Delta t_{GT}=12600$ s
	\\ \hline
	SW & $N_{\Delta t_A}=N_{\Delta t_{GT}}=32$ & $\Delta t_A=3368$ s
	& 0.047170 m$^6$/s$^2$
	\\ & & $\Delta t_{GT}=3716$ s
	\\ \hline
	SW+IT & $N_{\Delta t_A}=N_{\Delta t_{GT}}=16$ & $\Delta t_A=3266$ s
	& 0.047413 m$^6$/s$^2$
	\\ & $N_i=4$, $N_b=4$, $tol=0.5$ & $\Delta t_{GT}=3840$ s
	\\ \hline
	MC & $N_s=1024$ & $\Delta t_A=3193$ s & 0.047183 m$^6$/s$^2$
	\\ & & $\Delta t_{GT}=3705$ s
	\\ \hline
	MC+IT & $N_s=256$ & $\Delta t_A=3250$ s & 0.047139 m$^6$/s$^2$
	\\ & $N_i=N_b=4$, $tol=0.1$ & $\Delta t_{GT}=3751$ s
	\\ \hline
	MC+DS+RA & $N_s=768$, $N_{st}=4$ & $\Delta t_A=3211$ s
		& 0.047129 m$^6$/s$^2$
	\\ & $N_e=64$, $rel=1$ & $\Delta t_{GT}=3754$ s
	\\ & $st_{\Delta t_A}=st_{\Delta t_{GT}}=10$ s 
	\\ \hline
	GE & $N_p=256$, $N_g=9$ & $\Delta t_A=3274$ s & 0.047134 m$^6$/s$^2$
	\\ & $R_m=R_r=R_a=0.125$ & $\Delta t_{GT}=3753$ s
	\\ \hline
	GE & $N_p=64$, $N_g=21$ & $\Delta t_A=3338$ s & 0.047150 m$^6$/s$^2$
	\\ & $R_m=R_r=R_a=0.25$ & $\Delta t_{GT}=3740$ s
	\\ \hline
}{Optimal empirical parameters and value of the evaluation function in the simulation of the Canal de Violada using program SWIGS and several optimization algorithms in MPCOTool with the same total number of simulations ($N_{total}=1024$)}
{TabSwigs}

Fig.~\ref{FigSwigs} shows the supplied discharges at the inlet and at the
different gates using the default schedule developed by the channel guards and
that obtained in the best of our simulations. It can be observed that in both
cases the desired discharge at the different gates in Almudévar, Gurrea and El
Temple is supplied, with some transient peaks affecting the outlet discharge.
This work confirms that an optimized management reduces remarkably the amplitude
and the duration of these undesired peaks.

\FIGII{Violada-contributions.eps}{Violada-optimized-contributions.eps}
{Temporal evolution of discharges supplied at inlet, outlet and gates as (top)
using the opening times applied by the canal guards and (bottom) the optimum
opening times obtained in this work}{FigSwigs}

In order to illustrate the differences of the different algorithms, with regard 
to the ability of parallelization, in Fig.~\ref{FigSwigsLoad} the evolution 
of the number of active cores as a function of the calculation time at the
Memento cluster is shown for the method MC+DS+RA. A vertical line has been
drawn to distinguish between the end of the initial MC algorithm and the
beginning of the DS+RA algorithm. In this case, 768 simulations were carried out by MC, 
distributing 12 simulations on each one of the 64 utilized cores, which allowed 
quite an equilibrated parallelization, obtaining an average of 60.3 active
cores and approximately 70 simulations per hour. Ultimately, some cores 
finalized their simulations faster than others, so that some cores were 
deactivated until the calculation of the others was performed. Approximately after 11 hours of
calculation, the DS+RA commenced carrying out 64 simulations (only one per core)
and this process was iterated 4 times. On average, this algorithm only achieved
41.2 active cores performing less than 40 simulations per hour. This inferior 
result is due to the fact that the faster and slower simulations are more 
easily compensated when executing 12 simulations per core than one. Overall, the
algorithm has maintained 52.7 active cores on average and lasted about
18 hours to complete the 1024 simulations, being one of the slowest of all
used algorithms. 
\PLOT{load-swigs-mc-ra-768-1-64-4.eps}
{Temporal evolution of the number of active cores for the MC+DS+RA optimization.
A vertical line has been drawn to distinguish between the end of the initial MC algorithm and the
beginning of the DS+RA algorithm}{FigSwigsLoad}

\section{Conclusions}

MPCOTool has proved to be flexible in the adaptation to the syntax of diverse simulation codes and useful in the calibration and optimization of parameters involved in rather different irrigation problems. In the present work it has been shown successful for practical applications such as open channel flow management, furrow fertigation, sprinkler irrigation and sprinkler tower movement design.

The new tool allows an efficient performance, making the most of the processors present in a single computer and allowing an easy extension to parallelization distributed among different computers. In whole, a considerable data capacity and computational speed are achieved with independence of the physical problem under study or the algorithm chosen.

For the analyzed cases, all the implemented optimization algorithms have reached similar results with the same total number of simulations. However, the iterative algorithm applied in combination with the Monte-Carlo method and the genetic algorithm leads to slightly better results than the pure brute force techniques.

\section*{Acknowledgements}

The authors would like to thank Arturo Giner, Guillermo Losilla and Patricia
Santos for their support and the BIFI Institute for letting us the use of the
Memento cluster. This research was funded by the MCINN of the Government of
Spain through grants AGL2010-21681-C03-01 and BIA2011-30192-C02-01, and the
FPI-MINECO PhD grants program.

\section*{References}
\bibliography{bib}

\end{document}
