CC = @CC@ @ARCH@ @LTO@ @STD@ @MPI_DEFINE@
CFLAGS = -g -Wall -O3 @CPPFLAGS@ @GSL_CFLAGS@ @XML_CFLAGS@ @GLIB_CFLAGS@ \
	@GTHREAD_CFLAGS@
LDFLAGS = @LDFLAGS@ @LIBS@ @GSL_LIBS@ @XML_LIBS@ @GLIB_LIBS@ @GTHREAD_LIBS@

SRC = genetic/entity.c genetic/population.c genetic/reproduction.c \
	genetic/selection.c genetic/evolution.c genetic/genetic.c calibrator.c
OBJ = genetic/entity.o genetic/population.o genetic/reproduction.o \
	genetic/selection.o genetic/evolution.o genetic/genetic.o
DEP = Makefile
ES = es/LC_MESSAGES/
FR = fr/LC_MESSAGES/
GB = en_GB/LC_MESSAGES/
T1 = tests/test1/
T2 = tests/test2/
T3 = tests/test3/
T4 = tests/test4/
TESTS = $(T1)simulator $(T1)evaluator $(T2)simulator $(T2)evaluator \
	$(T3)simulator $(T3)evaluator $(T4)simulator

all: calibratorbin \
	calibrator \
	locales/$(ES)calibrator.mo \
	locales/$(FR)calibrator.mo \
	$(TESTS)

genetic/entity.o: genetic/entity.c genetic/entity.h $(DEP)
	$(CC) $(CFLAGS) -c genetic/entity.c -o genetic/entity.o

genetic/population.o: genetic/population.c genetic/population.h \
	genetic/entity.h genetic/bits.h $(DEP)
	$(CC) $(CFLAGS) -c genetic/population.c -o genetic/population.o

genetic/reproduction.o: genetic/reproduction.c genetic/reproduction.h \
	genetic/entity.h genetic/bits.h $(DEP)
	$(CC) $(CFLAGS) -c genetic/reproduction.c -o genetic/reproduction.o

genetic/selection.o: genetic/selection.c genetic/selection.h \
	genetic/population.h genetic/entity.h $(DEP)
	$(CC) $(CFLAGS) -c genetic/selection.c -o genetic/selection.o

genetic/evolution.o: genetic/evolution.c genetic/evolution.h \
	genetic/selection.h genetic/reproduction.h genetic/mutation.h \
	genetic/population.h genetic/entity.h genetic/sort.h genetic/bits.h $(DEP)
	$(CC) $(CFLAGS) -c genetic/evolution.c -o genetic/evolution.o

genetic/genetic.o: genetic/genetic.c genetic/genetic.h genetic/evolution.h \
	genetic/selection.h genetic/reproduction.h genetic/population.h \
	genetic/entity.h genetic/bits.h $(DEP)
	$(CC) $(CFLAGS) -c genetic/genetic.c -o genetic/genetic.o

calibratorbin: calibrator.c calibrator.h $(OBJ) config.h
	$(CC) $(CFLAGS) calibrator.c $(OBJ) $(LDFLAGS) -o calibratorbin

calibrator: calibrator.c interface.h calibrator.h $(OBJ) @ICON@ config.h
	$(CC) $(CFLAGS) @GTK_CFLAGS@ @WINCFLAGS@ calibrator.c $(OBJ) @ICON@ \
		$(LDFLAGS) @GTK_LIBS@ -o calibrator -DHAVE_GTK=1

locales/calibrator.pot: calibrator
	xgettext -d calibrator -o locales/calibrator.pot --from-code=UTF-8 \
		$(SRC)

locales/$(ES)calibrator.po: locales/calibrator.pot
	test -d locales/$(ES) || mkdir -p locales/$(ES)
	test -f locales/$(ES)calibrator.po || \
		msginit -l es -o locales/$(ES)calibrator.po -i locales/calibrator.pot \
		--no-translator
	msgmerge -U locales/$(ES)calibrator.po locales/calibrator.pot
	vim -p locales/$(ES)calibrator.po
	touch locales/$(ES)calibrator.po

locales/$(ES)calibrator.mo: locales/$(ES)calibrator.po locales/calibrator.pot
	msgfmt -c -v -o locales/$(ES)calibrator.mo locales/$(ES)calibrator.po

locales/$(FR)calibrator.po: locales/calibrator.pot
	test -d locales/$(FR) || mkdir -p locales/$(FR)
	test -f locales/$(FR)calibrator.po || \
		msginit -l fr -o locales/$(FR)calibrator.po -i locales/calibrator.pot \
		--no-translator
	msgmerge -U locales/$(FR)calibrator.po locales/calibrator.pot
	vim -p locales/$(FR)calibrator.po
	touch locales/$(FR)calibrator.po

locales/$(FR)calibrator.mo: locales/$(FR)calibrator.po locales/calibrator.pot
	msgfmt -c -v -o locales/$(FR)calibrator.mo locales/$(FR)calibrator.po

$(T1)simulator: $(T1)simulator.c $(T1)Makefile
	cd $(T1); make

$(T1)evaluator: $(T1)evaluator.c $(T1)Makefile
	cd $(T1); make

$(T2)simulator: $(T2)simulator.c $(T2)Makefile
	cd $(T2); make

$(T2)evaluator: $(T2)evaluator.c $(T2)Makefile
	cd $(T2); make

$(T3)simulator: $(T3)simulator.c $(T3)Makefile
	cd $(T3); make

$(T3)evaluator: $(T3)evaluator.c $(T3)Makefile
	cd $(T3); make

$(T4)simulator: $(T4)simulator.c $(T4)Makefile
	cd $(T4); make

@ICON@: calibrator.rc logo.png
	convert logo.png calibrator.ico
	@WINDRES@ calibrator.rc -o @ICON@

doc: calibrator.c config.h README.md $(DEP)
	doxygen
	cd latex; make

BIN = @PREFIX@/bin/
DLL = $(BIN)libatk-1.0-0.dll\
	$(BIN)libbz2-1.dll\
	$(BIN)libcairo-2.dll\
	$(BIN)libcairo-gobject-2.dll\
	$(BIN)libepoxy-0.dll\
	$(BIN)libexpat-1.dll\
	$(BIN)libffi-6.dll\
	$(BIN)libfontconfig-1.dll\
	$(BIN)libfreetype-6.dll\
	$(BIN)libgcc_s_seh-1.dll\
	$(BIN)libgdk_pixbuf-2.0-0.dll\
	$(BIN)libgdk-3-0.dll\
	$(BIN)libgio-2.0-0.dll\
	$(BIN)libglib-2.0-0.dll\
	$(BIN)libgmodule-2.0-0.dll\
	$(BIN)libgobject-2.0-0.dll\
	$(BIN)libgsl-0.dll\
	$(BIN)libgslcblas-0.dll\
	$(BIN)libgthread-2.0-0.dll\
	$(BIN)libgtk-3-0.dll\
	$(BIN)libharfbuzz-0.dll\
	$(BIN)libiconv-2.dll\
	$(BIN)libintl-8.dll\
	$(BIN)libpango-1.0-0.dll\
	$(BIN)libpangocairo-1.0-0.dll\
	$(BIN)libpangoft2-1.0-0.dll\
	$(BIN)libpangowin32-1.0-0.dll\
	$(BIN)libpixman-1-0.dll\
	$(BIN)libpng16-16.dll\
	$(BIN)libwinpthread-1.dll\
	$(BIN)libxml2-2.dll\
	$(BIN)zlib1.dll
SHARE = @PREFIX@/share/
LOCALE = $(SHARE)locale/
MOGB = $(LOCALE)en_GB/LC_MESSAGES/gtk30.mo
MOES = $(LOCALE)es/LC_MESSAGES/gtk30.mo
MOFR = $(LOCALE)fr/LC_MESSAGES/gtk30.mo
MO = $(MOGB) $(MOES) $(MOFR)

windist: calibrator.exe $(DLL) $(MO)
	test -d win || rm -rf win
	mkdir -p win/bin/locales \
		win/share/locale \
		win/share/locale/{en_GB,es,fr}/LC_MESSAGES \
		win/share/glib-2.0/schemas
	cp *.exe $(DLL) win/bin
	strip win/bin/*.{exe,dll}
	cd locales; cp --parents {$(ES),$(FR)}calibrator.mo ../win/bin/locales
	cp --parents tests/test1/*{.exe,.exp,.tmp,win.xml} win/bin
	cp $(SHARE)glib-2.0/schemas/gschema{.dtd,s.compiled} \
		win/share/glib-2.0/schemas
	cd win/share; cp -r $(SHARE)icons .
	cd win/share/locale; cp $(MOGB) $(GB); cp $(MOES) $(ES); cp $(MOFR) $(FR)
